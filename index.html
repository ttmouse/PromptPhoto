<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PromptPhoto æç¤ºè¯ç”Ÿæˆå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+SC:wght@400;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      :root { --bg:#faf9fb; --panel:#ffffff; --text:#3a3a40; --muted:#7a7f86; --accent:#ff8aa0; --accent-2:#ff6f91; --accent-soft: rgba(255,111,145,.12); --accent-hover: rgba(255,111,145,.16); --border:#eceff3; --chip-bg:#fff3f5; --chip-hover:#ffe9ee; --shadow-soft: 0 8px 20px rgba(58,58,64,.06); }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body { margin:0; background:var(--bg); color:var(--text); font-family: Inter, "Noto Sans SC", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial; line-height: 1.6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; }
      .wrap { max-width: 1200px; margin: 0 auto; padding: 28px 28px 150px; }
      .header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:26px; }
      .title { font-size: 22px; font-weight: 700; letter-spacing: .15px; }
      html.lang-en .title { font-family: "Playfair Display", ui-serif, Georgia, "Times New Roman", serif; font-weight:600; }
      .controls { display:flex; gap:10px; flex-wrap:wrap; }
      button { background:var(--accent); color:#3a0d17; border:none; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:transform .08s ease; box-shadow: none; }
      button:active { transform: scale(.98); }
      .btn-cta { padding:12px 18px; font-weight:700; border-radius:14px; }
      .btn-secondary { background:var(--panel); color:var(--text); border:1px solid var(--border); }
      .grid { display:grid; grid-template-columns: minmax(0, 1.35fr) minmax(0, 1fr); gap:22px; align-items:start; }
      @media (max-width: 1200px) {
        .grid { grid-template-columns: 1fr; }
        .left-panel, .right-sticky { position:relative; height:auto; max-height:none; }
        .right-sticky { top:auto; }
      }
      .card { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow: var(--shadow-soft); }
      .left-panel { height: calc(100vh - 220px); display:flex; flex-direction:column; }
      .dimension-header { flex-shrink:0; display:flex; justify-content:space-between; align-items:center; padding-bottom:12px; margin-bottom:12px; border-bottom:1px solid var(--border); }
      .dimension-header h3 { margin:0; }
      .dimension-body { flex:1; overflow-y:auto; padding-right:4px; }
      .right-sticky { position: sticky; top: 96px; max-height: calc(100vh - 220px); height: calc(100vh - 220px); display:flex; flex-direction:column; overflow:hidden; }
      .right-sticky .output { flex:1; overflow:auto; }
      .card h3 { margin:0 0 12px 0; font-size:16px; font-weight:600; color:var(--accent-2); }
      .group { margin-bottom:18px; padding:12px; border-radius:14px; transition: background .2s ease; position:relative; }
      .group.collapsed,
      .group.group-disabled { padding-bottom:10px; margin-bottom:14px; }
      .group-content { padding-top:8px; }
      .group.group-disabled { background:#f4f5f8; }
      .group.group-locked { background:#f8f8fb; border-color:#e3e6ef; }
      .group.group-locked .group-title { color:#4d515c; }
      .group.group-disabled .group-content { display:none; }
      .group-title-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:wrap; position:relative; padding-left:28px; width:100%; }
      .group.collapsed > :not(.group-title-row) { display:none; }
      .group-title { font-size:14px; font-weight:600; color:var(--text); letter-spacing:.1px; flex:1; min-width:0; }
      .group.collapsed .group-title-row,
      .group.group-disabled .group-title-row { margin-bottom:0; }
      .group-actions { margin-left:auto; display:flex; align-items:center; gap:6px; flex-wrap:nowrap; }
      .options { display:flex; flex-wrap:wrap; gap:8px; }
      .option { background:#ffffff; color:var(--text); border:1px solid var(--border); border-radius:999px; padding:7px 12px; cursor:pointer; font-weight:400; letter-spacing:.1px; transition: background .2s ease, border-color .2s ease, color .2s ease; box-shadow:none; }
      .option:hover { background:var(--chip-hover); }
      .option.active { border-color: var(--accent); background: var(--accent-soft); color:#3a0d17; }
      .option:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }
      .option.disabled { opacity:.5; pointer-events:none; }
      .option.single-option { display:inline-flex; align-items:center; gap:6px; }
      .option.locked-view { border-color:#d9dce5; background:#f5f6fb; color:#5f6571; }
      .option .caret { display:inline-flex; align-items:center; justify-content:center; width:12px; height:12px; margin-left:6px; }
      .option .caret svg { width:12px; height:12px; stroke: var(--muted); fill:none; }
      .option.active .caret svg { stroke: var(--accent-2); }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .toggle { display:flex; align-items:center; gap:8px; padding:6px 6px; background:transparent; border:0; border-radius:10px; color:var(--muted); }
      .toggle input[type="checkbox"] { accent-color: var(--accent); width:16px; height:16px; }
      .toggle input:checked + label { color: var(--accent-2); }
      .group-disabled .group-title { color:#b0b4ba; }
      .group-disabled .option { background:#f8f8fb; border-color:#e3e5ec; color:#a5aab4; }
      .output { width:100%; min-height:260px; white-space:pre-wrap; background:#ffffff; border:1px solid var(--border); border-radius:12px; padding:14px; color:var(--text); font-size:14px; font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .scroll-soft { scrollbar-width: thin; scrollbar-color: rgba(122,127,134,.25) transparent; }
      .scroll-soft::-webkit-scrollbar { width:6px; }
      .scroll-soft::-webkit-scrollbar-track { background: transparent; }
      .scroll-soft::-webkit-scrollbar-thumb { background: rgba(122,127,134,.3); border-radius:999px; border:1px solid rgba(255,255,255,.4); }
      .scroll-soft:hover::-webkit-scrollbar-thumb { background: rgba(122,127,134,.45); }
      .custom-section { border-top:1px solid var(--border); margin-top:20px; padding-top:16px; }
      .custom-section-header { display:flex; justify-content:flex-start; align-items:center; margin-bottom:10px; }
      .custom-form { display:flex; flex-direction:column; gap:8px; margin-bottom:16px; }
      .custom-form .row { display:flex; gap:8px; flex-wrap:wrap; }
      .custom-form input, .custom-form textarea { width:100%; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-family:inherit; font-size:13px; color:var(--text); background:#fff; }
      .custom-form textarea { min-height:80px; resize:vertical; }
      .custom-form-actions { display:flex; gap:8px; }
      .custom-hint { font-size:12px; color:var(--muted); margin:0; }
      .custom-status { font-size:12px; color:var(--accent-2); margin:0; min-height:16px; }
      .custom-dimensions-list { display:flex; flex-direction:column; gap:14px; }
      .custom-dimension-card { border:1px solid var(--border); border-radius:14px; padding:12px; }
      .custom-dimension-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
      .custom-dimension-name { font-weight:600; font-size:13px; color:var(--muted); }
      .custom-actions { display:flex; gap:6px; }
      .custom-text-btn { background:transparent; border:none; color:var(--accent-2); font-size:12px; cursor:pointer; padding:4px 6px; border-radius:8px; }
      .custom-text-btn:hover { background:var(--accent-soft); }
      .custom-add-btn { background:#ff4d4f; color:#fff; border:none; border-radius:14px; padding:8px 16px; font-weight:600; cursor:pointer; box-shadow:var(--shadow-soft); transition:transform .08s ease; }
      .custom-add-btn:active { transform:scale(.98); }
      .custom-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:120; }
      .custom-modal-overlay.hidden { display:none; }
      .custom-modal { background:var(--panel); border-radius:20px; padding:24px; width:min(420px, 90vw); box-shadow:var(--shadow-soft); border:1px solid var(--border); display:flex; flex-direction:column; gap:14px; }
      .custom-modal-header { display:flex; justify-content:space-between; align-items:center; }
      .custom-modal-header h3 { margin:0; font-size:16px; color:var(--accent-2); }
      .custom-modal-close { background:transparent; border:none; font-size:18px; line-height:1; cursor:pointer; color:var(--muted); padding:4px; border-radius:8px; }
      .custom-modal-close:hover { color:var(--accent-2); background:var(--accent-soft); }
      body.modal-open { overflow:hidden; }
      .hidden { display:none !important; }
      
      .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:var(--chip-bg); border:1px solid var(--border); color:var(--muted); }
      .footer { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:16px; }
      .small { font-size:12px; color:var(--muted); }
      .lang-toggle { display:flex; gap:6px; }
      .lang-btn { background:var(--chip-bg); color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:400; box-shadow:none; }
      .lang-btn.active { border-color: var(--accent); color:#3a0d17; background: var(--accent-soft); }
      .lang-btn:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }
      .btn-cta { padding:12px 18px; font-weight:700; border-radius:14px; box-shadow: 0 6px 14px rgba(255,111,145,.12); }
      .sub-title { font-size:12px; font-weight:500; color:var(--muted); }
      .sub-title-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; position:relative; padding-left:24px; }
      .sub-actions { margin-left:auto; display:flex; align-items:center; gap:4px; }
      .sub-title-row .lock-btn { margin-left:0; }
      .sub-title-row .visibility-btn { padding:4px; border-radius:50%; }
      .sub-disabled .sub-title { color:#c6cad3; }
      .sub-title-row.sub-locked .sub-title { color:#4c4f59; font-weight:600; }
      .options-block.sub-disabled,
      .options.sub-disabled { display:none; }
      .options.sub-locked .option,
      .options-block.sub-locked .option { background:#f8f8fb; color:#5c606a; border-color:#d9dce5; }
      .options-block { margin-bottom:8px; }
      .options-block.collapsed { display:none; }
      select { width:100%; appearance:none; -webkit-appearance:none; -moz-appearance:none; background-color:#fff; border:1px solid var(--border); color:var(--text); border-radius:10px; padding:8px 34px 8px 10px; line-height:1.4; font-size:14px; background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='none' stroke='%237a7f86' stroke-width='2' d='M7 10l5 5 5-5'/></svg>"); background-repeat:no-repeat; background-position: calc(100% - 10px) 50%; background-size:12px; }
      .lock-btn { background:transparent; border:none; color:var(--muted); padding:4px; border-radius:50%; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; width:auto; }
      .lock-btn svg { width:16px; height:16px; stroke: currentColor; fill:none; }
      .lock-btn:hover { color:var(--accent-2); }
      .lock-btn.locked { color:var(--accent-2); }
      .lock-btn:focus-visible { outline:2px solid var(--accent-soft); outline-offset:2px; }
      .option-lock-btn { background:transparent; border:none; color:#9499a7; padding:4px; border-radius:50%; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
      .option-lock-btn:hover { color:var(--accent-2); }
      .option-lock-btn:focus-visible { outline:2px solid var(--accent-soft); outline-offset:2px; }
      .option-lock-btn svg { width:14px; height:14px; stroke:currentColor; fill:none; }
      .locked-chip { display:flex; align-items:center; gap:6px; }
      .locked-chip .option { margin:0; }
      .group.group-disabled .lock-btn,
      .group.group-disabled .collapse-btn,
      .group.group-disabled .visibility-btn { color:#c0c4cf; }
      .collapse-btn { background:transparent; border:none; padding:4px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; color:var(--muted); position:absolute; left:0; top:50%; transform: translateY(-50%); }
      .collapse-btn svg { width:16px; height:16px; stroke:currentColor; fill:none; transition: transform .2s ease; }
      .collapse-btn:focus-visible { outline:2px solid var(--accent-soft); outline-offset:2px; }
      .collapse-btn.collapsed svg { transform: rotate(-90deg); }
      .visibility-btn { background:transparent; border:none; color:var(--muted); padding:4px; border-radius:50%; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
      .visibility-btn svg { width:16px; height:16px; stroke:currentColor; fill:none; }
      .visibility-btn:focus-visible { outline:2px solid var(--accent-soft); outline-offset:2px; }
      .global-bar { position: fixed; bottom: 20px; left:50%; transform: translateX(-50%); background: rgba(255,255,255,.92); border:1px solid var(--border); box-shadow: 0 12px 30px rgba(0,0,0,.08); border-radius:18px; padding:10px 14px; display:flex; gap:10px; z-index:50; backdrop-filter: blur(8px); }
      .action-btn { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:999px; padding:9px 16px; font-size:13px; font-weight:600; box-shadow: inset 0 1px 0 rgba(255,255,255,.6); transition: all .15s ease; }
      .action-btn:hover { border-color: var(--accent-2); color: var(--accent-2); }
      .action-btn.copied { border-color: var(--accent-2); color: var(--accent-2); background:var(--accent-soft); }
      .action-btn.accent { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color:#fff; border:none; box-shadow:none; }
      .action-btn.accent:hover { filter: brightness(1.05); }
      .btn-icon { display:inline-flex; align-items:center; justify-content:center; }
      .action-btn svg { width:16px; height:16px; stroke:currentColor; fill:none; }
      .action-btn.accent svg { stroke:#fff; }
      .v-subtitle { font-size:12px; color:var(--muted); margin:6px 0; }
      .v-subitems { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px; }
      .popover { position:absolute; z-index:1000; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow: var(--shadow-soft); padding:6px; }
      .popover ul { list-style:none; margin:0; padding:0; max-height:220px; overflow:auto; }
      .popover li { padding:6px 8px; border-radius:8px; cursor:pointer; }
      .popover li:hover { background:var(--chip-hover); }
      .saved-strip { position:fixed; left:16px; top:50%; transform: translateY(-50%); display:flex; flex-direction:column; gap:8px; width:180px; padding:12px; border-radius:16px; border:1px solid var(--border); background:var(--panel); box-shadow: var(--shadow-soft); z-index:80; }
      .saved-strip.hidden { display:none; }
      .saved-strip h4 { margin:0; font-size:13px; color:var(--muted); }
      .saved-strip-list { display:flex; flex-direction:column; gap:6px; max-height:calc(100vh - 180px); overflow:auto; padding-right:2px; }
      .saved-strip-item { border:1px solid var(--border); border-radius:10px; padding:6px 8px; font-size:12px; display:flex; align-items:center; justify-content:space-between; gap:6px; cursor:pointer; transition: background .15s ease, border-color .15s ease; }
      .saved-strip-item:hover { background:var(--chip-hover); }
      .saved-strip-item.active { border-color: var(--accent); background: var(--accent-soft); color:#3a0d17; }
      .saved-strip-item-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .saved-strip-item button { border:none; background:transparent; color:inherit; cursor:pointer; padding:0 4px; font-size:12px; }
      .saved-strip-item button:hover { color:var(--accent-2); }
      .preset-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:100; }
      .preset-modal-overlay.hidden { display:none; }
      .preset-modal { background:var(--panel); border-radius:20px; padding:24px; width:min(320px, 90vw); display:flex; flex-direction:column; gap:14px; box-shadow:var(--shadow-soft); border:1px solid var(--border); }
      .preset-modal h3 { margin:0; font-size:16px; color:var(--accent-2); text-align:center; }
      .preset-modal input { border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:13px; }
      .preset-modal .modal-actions { display:flex; gap:10px; }
      .preset-modal .modal-actions button { flex:1; }
      .preset-modal .action-btn { width:100%; justify-content:center; }
      @media (max-width: 768px) {
        .saved-strip { left:12px; width:160px; top:auto; bottom:90px; transform:none; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div class="title" id="appTitle">PromptPhoto æç¤ºè¯ç”Ÿæˆå™¨</div>
        <div class="controls">
          <div class="lang-toggle">
            <button id="lang-zh" class="lang-btn active">ä¸­æ–‡</button>
            <button id="lang-en" class="lang-btn">EN</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card left-panel">
          <div class="row dimension-header">
            <h3 id="dimensionHeading">ç»´åº¦é€‰æ‹©</h3>
            <button id="modeToggle" class="btn-secondary" title="åˆ‡æ¢è§†å›¾æ¨¡å¼">ä¸‹æ‹‰æ¨¡å¼</button>
          </div>
          <div class="dimension-body scroll-soft">
          <div class="group" id="group-hair-style">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="hairStyle" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="hairStyle">å¤´å‘é€ å‹</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="hairStyle" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="hairStyle" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
              <div class="options" id="hairStyle"></div>
            </div>
          </div>
          <div class="group" id="group-hair-color">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="hairColor" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="hairColor">å‘è‰²</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="hairColor" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="hairColor" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
              <div class="options" id="hairColor"></div>
            </div>
          </div>
            <div class="group" id="group-clothing">
              <div class="group-title-row">
                <button class="collapse-btn" data-group="clothing" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
                <div class="group-title" data-group="clothing">æœé¥°ä¸é¥°å“</div>
                <div class="group-actions">
                  <button class="visibility-btn" data-group="clothing" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                  <button class="lock-btn" data-group="clothing" aria-label="é”å®š">ğŸ”“</button>
                </div>
              </div>
              <div class="group-content">
              <div class="sub-title-row">
                <button class="collapse-btn sub-collapse" data-sub-target="top" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
                <div class="sub-title" data-sub="top">ä¸Šè¡£</div>
                <div class="sub-actions">
                  <button class="visibility-btn" data-sub="top" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                  <button class="lock-btn" data-sub="top" aria-label="é”å®š">ğŸ”“</button>
                </div>
              </div>
              <div class="options options-block" id="top"></div>
              <div class="sub-title-row">
                <button class="collapse-btn sub-collapse" data-sub-target="earrings" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
                <div class="sub-title" data-sub="earrings">è€³é¥°</div>
                <div class="sub-actions">
                  <button class="visibility-btn" data-sub="earrings" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                  <button class="lock-btn" data-sub="earrings" aria-label="é”å®š">ğŸ”“</button>
                </div>
              </div>
              <div class="options options-block" id="earrings"></div>
              <div class="sub-title-row">
                <button class="collapse-btn sub-collapse" data-sub-target="rings" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
                <div class="sub-title" data-sub="rings">æˆ’æŒ‡</div>
                <div class="sub-actions">
                  <button class="visibility-btn" data-sub="rings" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                  <button class="lock-btn" data-sub="rings" aria-label="é”å®š">ğŸ”“</button>
                </div>
              </div>
              <div class="options options-block" id="rings"></div>
              <div class="sub-title-row">
                <button class="collapse-btn sub-collapse" data-sub-target="nails" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
                <div class="sub-title" data-sub="nails">æŒ‡ç”²</div>
                <div class="sub-actions">
                  <button class="visibility-btn" data-sub="nails" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                  <button class="lock-btn" data-sub="nails" aria-label="é”å®š">ğŸ”“</button>
                </div>
              </div>
              <div class="options options-block" id="nails"></div>
              </div>
            </div>
          <div class="group" id="group-makeup">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="makeup" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="makeup">å¦†å®¹</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="makeup" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="makeup" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="makeupStyle" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="makeupStyle">å¦†å®¹é£æ ¼</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="makeupStyle" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="makeupStyle" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="makeupStyle"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="eyebrows" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="eyebrows">çœ‰æ¯›</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="eyebrows" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="eyebrows" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="eyebrows"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="eyeliner" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="eyeliner">çœ¼çº¿</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="eyeliner" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="eyeliner" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="eyeliner"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="eyelashes" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="eyelashes">ç«æ¯›</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="eyelashes" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="eyelashes" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="eyelashes"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="blush" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="blush">è…®çº¢</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="blush" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="blush" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="blush"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="lips" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="lips">å”‡å¦†</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="lips" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="lips" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="lips"></div>
            </div>
          </div>
          <div class="group" id="group-pose">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="pose" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="pose">å§¿æ€ä¸æœºä½</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="pose" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="pose" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="hands" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="hands">æ‰‹éƒ¨åŠ¨ä½œ</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="hands" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="hands" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="hands"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="expression" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="expression">è¡¨æƒ…</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="expression" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="expression" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="expression"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="cameraAngle" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="cameraAngle">æœºä½è§’åº¦</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="cameraAngle" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="cameraAngle" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="cameraAngle"></div>
            </div>
          </div>
          <div class="group" id="group-composition">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="composition" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="composition">æ„å›¾æ¯”ä¾‹</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="composition" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="composition" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="aspectRatio" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="aspectRatio">ç”»é¢æ¯”ä¾‹</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="aspectRatio" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="aspectRatio" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="aspectRatio"></div>
            </div>
          </div>
          <div class="group" id="group-background">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="background" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="background">èƒŒæ™¯ä¸å…‰çº¿</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="background" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="background" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="bgColor" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="bgColor">èƒŒæ™¯è‰²/å¢™ä½“</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="bgColor" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="bgColor" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="bgColor"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="bgEffect" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="bgEffect">èƒŒæ™¯æ•ˆæœ</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="bgEffect" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="bgEffect" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="bgEffect"></div>
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="lighting" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="lighting">å…‰çº¿æ¡ä»¶</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="lighting" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="lighting" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="lighting"></div>
            </div>
          </div>
          <div class="group" id="group-style">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="style" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="style">é£æ ¼</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="style" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="style" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="mood" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="mood">é£æ ¼æ°›å›´</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="mood" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="mood" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="mood"></div>
            </div>
          </div>
          <div class="group" id="group-camera">
            <div class="group-title-row">
              <button class="collapse-btn" data-group="camera" aria-label="æŠ˜å /å±•å¼€"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="group-title" data-group="camera">ç›¸æœº</div>
              <div class="group-actions">
                <button class="visibility-btn" data-group="camera" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-group="camera" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="group-content">
            <div class="sub-title-row">
              <button class="collapse-btn sub-collapse" data-sub-target="cameraType" aria-label="æŠ˜å /å±•å¼€é€‰é¡¹"><svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke-width="2"/></svg></button>
              <div class="sub-title" data-sub="cameraType">ç›¸æœºç±»å‹</div>
              <div class="sub-actions">
                <button class="visibility-btn" data-sub="cameraType" aria-label="å¯ç”¨/ç¦ç”¨"></button>
                <button class="lock-btn" data-sub="cameraType" aria-label="é”å®š">ğŸ”“</button>
              </div>
            </div>
            <div class="options options-block" id="cameraType"></div>
            </div>
          </div>
          <div class="custom-section">
            <div class="custom-section-header">
              <button id="customAddTrigger" class="custom-add-btn" type="button">æ·»åŠ ç»´åº¦</button>
            </div>
            <div id="customDimensionsContainer" class="custom-dimensions-list"></div>
          </div>
        </div>
        </div>
        <div class="card right-sticky">
          <h3 id="outputHeading">JSON è¾“å‡º</h3>
          <div id="promptOutput" class="output scroll-soft"></div>
        </div>
      </div>
      <div id="savedStrip" class="saved-strip hidden">
        <h4 id="savedStripTitle">é…ç½®ç¼“å­˜</h4>
        <div id="savedStripList" class="saved-strip-list scroll-soft"></div>
      </div>

      <div id="presetModalOverlay" class="preset-modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="preset-modal">
          <h3 id="presetModalTitle">ä¿å­˜é…ç½®</h3>
          <input id="presetModalInput" type="text" placeholder="é…ç½®åç§°"/>
          <div class="modal-actions">
            <button id="presetModalCancel" class="action-btn" type="button">å–æ¶ˆ</button>
            <button id="presetModalSave" class="action-btn accent" type="button">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <div id="customModalOverlay" class="custom-modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="custom-modal">
          <div class="custom-modal-header">
            <h3 id="customModalTitle">æ·»åŠ ç»´åº¦</h3>
            <button id="customModalClose" class="custom-modal-close" type="button" aria-label="å…³é—­">Ã—</button>
          </div>
          <div class="custom-form" id="customForm">
            <div class="row">
              <input id="customNameZh" type="text" placeholder="ç»´åº¦åç§°ï¼ˆä¸­æ–‡ï¼‰"/>
              <input id="customNameEn" type="text" placeholder="Dimension name (EN)"/>
            </div>
            <textarea id="customOptionsInput" placeholder="æ¯è¡Œï¼šæŸ”å’Œå…‰çº¿ | Soft lighting"></textarea>
            <p class="custom-hint" id="customOptionsHint">ä½¿ç”¨â€œä¸­æ–‡ | Englishâ€æ ¼å¼ï¼Œä¸€è¡Œä¸€ä¸ªé€‰é¡¹ã€‚</p>
            <div class="custom-form-actions">
              <button id="customCancelBtn" class="btn-secondary" type="button">å–æ¶ˆ</button>
              <button id="customSaveBtn" class="btn-cta" type="button">æ·»åŠ ç»´åº¦</button>
            </div>
            <p class="custom-status" id="customFormStatus"></p>
          </div>
        </div>
      </div>

      <div class="global-bar">
        <button id="randomAll" class="action-btn accent">
          <span class="btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="16 3 21 3 21 8"></polyline>
              <line x1="4" y1="20" x2="9" y2="15"></line>
              <line x1="4" y1="4" x2="15" y2="15"></line>
              <polyline points="16 16 21 16 21 21"></polyline>
              <line x1="15" y1="9" x2="21" y2="15"></line>
            </svg>
          </span>
          <span id="randomLabel">éšæœº</span>
        </button>
        <button id="copyPrompt" class="action-btn">
          <span class="btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
          </span>
          <span id="copyLabel">å¤åˆ¶</span>
        </button>
        <button id="savedPanelToggle" class="action-btn" type="button">
          <span class="btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16l1 4H3z"></path>
              <path d="M6 12v7h12v-7"></path>
              <path d="M10 12v4"></path>
              <path d="M14 12v4"></path>
            </svg>
          </span>
          <span id="saveLabel">ä¿å­˜</span>
        </button>
      </div>
    </div>

    <script>
      const STORAGE_KEY = 'promptPhotoSelections_v1';
      function loadPersistedState() {
        if (typeof window === 'undefined' || typeof window.localStorage === 'undefined') return null;
        try {
          const raw = window.localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          return null;
        }
      }
      function saveToStorage(data) {
        if (typeof window === 'undefined' || typeof window.localStorage === 'undefined') return;
        try {
          window.localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {}
      }
      const savedData = loadPersistedState();
      const defaults = {
        subject: "Baby ê•¤ Blue",
        description: "Create a realistic close-up selfie of a young woman (face must be 100% unchanged). The photo is taken with a digital camera in a dimly lit room using a powerful camera flash, creating sharp contrast between the illuminated face and the dark background. The color tones combine a cozy feeling with modern simplicity, featuring cool tones and soft textures of the knitted clothing.",
        hair: {
          style: "Long dark brown hair, side part on the left, Korean-style loose curls at the ends, small front strands, hair blowing slightly across the face",
          color: "Dark brown"
        },
        clothing: {
          top: "Oversized blue striped knit sweater with white stripes",
          accessories: {
            earrings: "Small simple silver hoops",
            rings: "Delicate silver rings"
          },
          nails: "Almond-shaped, blue with subtle sparkling crystals"
        },
        makeup: {
          style: "Korean-style makeup",
          details: {
            skin: "Smooth and clear",
            eyebrows: "Light natural and tidy",
            eyeliner: "Soft, blurred Korean-style",
            eyelashes: "Thin false eyelashes",
            blush: "Light nude on cheeks, soft red on nose",
            lips: "Nude with a hint of red"
          }
        },
        pose: {
          hands: "Both hands gently touching cheeks",
          expression: "Dreamy and slightly cheerful",
          camera_angle: "High-angle selfie, approx 30 degrees above the face"
        },
        background: {
          color: "Dark wall with shallow depth, contrasting with flash lighting",
          lighting: "Cool dim light with flash highlighting the face, hair, skin, and clothing texture",
          effect: "Minimalist, modern, friendly, with slight reflective highlights"
        },
        style: {
          mood: "Film noir elegance",
          effects: "Prominent light and shadow, cinematic allure, high-detail, ultra-realistic"
        },
        camera: {
          type: "Analog 35mm camera flash",
          lighting_condition: "Dark room"
        },
        composition: {
          aspect_ratio: "3:4"
        },
        model_version: "SDXL1.0"
      };
      const descriptions = {
        en: defaults.description,
        zh: "ç”Ÿæˆä¸€å¼ å¹´è½»å¥³æ€§çš„çœŸå®æ„Ÿç‰¹å†™è‡ªæ‹ï¼ˆé¢éƒ¨å¿…é¡»ä¿æŒ 100% ä¸å˜ï¼‰ã€‚åœ¨æ˜æš—æˆ¿é—´ä½¿ç”¨æ•°ç ç›¸æœºå¼ºåŠ›é—ªå…‰æ‹æ‘„ï¼Œå½¢æˆé¢éƒ¨é«˜å…‰ä¸æ·±è‰²èƒŒæ™¯çš„é²œæ˜å¯¹æ¯”ã€‚æ•´ä½“è‰²è°ƒå°†æ¸©æš–èˆ’é€‚ä¸ç°ä»£ç®€çº¦ç»“åˆï¼Œä½“ç°å†·è‰²è°ƒä¸é’ˆç»‡æœé¥°çš„æŸ”è½¯è´¨æ„Ÿã€‚"
      };

      let customDimensions = Array.isArray(savedData?.customDimensions) ? savedData.customDimensions : [];
      const normalizedSaved = Array.isArray(savedData?.savedConfigs) ? savedData.savedConfigs : [];
      let savedConfigs = normalizeSavedConfigs(normalizedSaved);
      let activeSavedConfigId = savedData?.activeSavedConfigId || null;
      if (activeSavedConfigId && !savedConfigs.some(cfg => cfg.id === activeSavedConfigId)) {
        activeSavedConfigId = null;
      }
      let editingCustomId = null;
      let copyFeedbackTimer = null;
      const current = { lang: savedData?.currentLang || 'zh' };
      function updateLangClass() {
        document.documentElement.lang = current.lang;
        document.documentElement.classList.toggle('lang-en', current.lang === 'en');
      }
      updateLangClass();
      let uiMode = savedData?.uiMode || 'dropdown';
      const options = {
        hairStyle: [
          { en: "Long dark brown hair, side part on the left, Korean-style loose curls at the ends, small front strands, hair blowing slightly across the face", zh: "æ·±æ£•è‰²é•¿å‘ï¼Œå·¦ä¾§ååˆ†ï¼ŒéŸ©ç³»å°¾éƒ¨è‡ªç„¶å¤§å·ï¼Œç¢å‘è½»æ‹‚è„¸é¢Š" },
          { en: "Medium-length hair, soft waves, curtain bangs", zh: "ä¸­é•¿å‘ï¼ŒæŸ”å’Œæ³¢æµªå·ï¼Œçª—å¸˜åˆ˜æµ·" },
          { en: "Straight long hair, center part, silky texture", zh: "ç›´å‘é•¿å‘ï¼Œä¸­åˆ†ï¼Œé¡ºæ»‘è´¨æ„Ÿ" },
          { en: "Short bob, subtle waves, side-swept bangs", zh: "çŸ­æ³¢æ³¢å¤´ï¼Œå¾®å·ï¼Œä¾§åˆ†åˆ˜æµ·" }
        ],
        hairColor: [
          { en: "Dark brown", zh: "æ·±æ£•è‰²" },
          { en: "Natural black", zh: "è‡ªç„¶é»‘" },
          { en: "Warm chestnut brown", zh: "æ¸©æš–æ —æ£•" },
          { en: "Ash brown", zh: "äºšéº»æ£•" }
        ],
        top: [
          { en: "Oversized blue striped knit sweater with white stripes", zh: "å®½æ¾è“ç™½æ¡çº¹é’ˆç»‡æ¯›è¡£" },
          { en: "Cozy navy knit sweater", zh: "èˆ’é€‚æµ·å†›è“é’ˆç»‡æ¯›è¡£" },
          { en: "Light blue cable-knit sweater", zh: "æµ…è“è‰²éº»èŠ±é’ˆç»‡æ¯›è¡£" },
          { en: "Blue-gray ribbed knit pullover", zh: "è“ç°è‰²ç½—çº¹å¥—å¤´è¡«" }
        ],
        nails: [
          { en: "Almond-shaped, blue with subtle sparkling crystals", zh: "æä»å½¢ï¼Œè“è‰²æ­é…ç»†å¾®æ™¶é’»é—ªå…‰" },
          { en: "Short natural nude nails", zh: "çŸ­æ¬¾è‡ªç„¶è£¸è‰²" },
          { en: "Almond-shaped, navy gradient with shimmer", zh: "æä»å½¢ï¼Œæµ·å†›è“æ¸å˜å¸¦å¾®å…‰" },
          { en: "Square blue nails, glossy finish", zh: "æ–¹å½¢è“è‰²ç”²ï¼Œäº®é¢" }
        ],
        earrings: [
          { en: "Small simple silver hoops", zh: "å°å·ç®€çº¦é“¶è‰²åœˆè€³ç¯" },
          { en: "Minimal silver studs", zh: "æç®€é“¶è‰²è€³é’‰" },
          { en: "Tiny pearl studs", zh: "å°å·§çç è€³é’‰" },
          { en: "Thin oval silver hoops", zh: "çº¤ç»†æ¤­åœ†é“¶åœˆè€³ç¯" }
        ],
        rings: [
          { en: "Delicate silver rings", zh: "ç»†è‡´é“¶è‰²æˆ’æŒ‡" },
          { en: "Stacked minimalist silver bands", zh: "å æˆ´æç®€é“¶æˆ’" },
          { en: "Single thin silver band", zh: "å•åªç»†é“¶æˆ’" },
          { en: "Geometric silver ring", zh: "å‡ ä½•é“¶æˆ’" }
        ],
        makeupStyle: [
          { en: "Korean-style makeup", zh: "éŸ©ç³»å¦†å®¹" },
          { en: "Soft natural makeup", zh: "æŸ”å’Œè‡ªç„¶å¦†" },
          { en: "Clean girl makeup", zh: "æ¸…çˆ½ clean girl å¦†" }
        ],
        blush: [
          { en: "Light nude on cheeks, soft red on nose", zh: "é¢é¢Šæµ…è£¸è‰²ï¼Œé¼»å°–æŸ”çº¢" },
          { en: "Subtle peach on cheeks", zh: "é¢é¢Šæ·¡èœœæ¡ƒè‰²" },
          { en: "Soft pink across cheeks and nose", zh: "é¢é¢Šä¸é¼»æ¢æŸ”ç²‰" }
        ],
        eyeliner: [
          { en: "Soft, blurred Korean-style", zh: "æŸ”å’Œæ™•æŸ“éŸ©ç³»çœ¼çº¿" },
          { en: "Thin natural eyeliner", zh: "ç»†è‡ªç„¶çœ¼çº¿" },
          { en: "Soft winged liner", zh: "æŸ”å’Œä¸Šæ‰¬çœ¼çº¿" }
        ],
        eyelashes: [
          { en: "Thin false eyelashes", zh: "è½»è–„å‡ç«æ¯›" },
          { en: "Natural mascara", zh: "è‡ªç„¶ç«æ¯›è†" },
          { en: "Feathery lashes", zh: "ç¾½æ„Ÿç«æ¯›" }
        ],
        eyebrows: [
          { en: "Light natural and tidy", zh: "è½»æŸ”è‡ªç„¶ã€æ¸…æ™°" },
          { en: "Soft arched brows", zh: "æŸ”å’Œå¼§å½¢çœ‰" },
          { en: "Straight natural brows", zh: "ç›´çº¿è‡ªç„¶çœ‰" }
        ],
        lips: [
          { en: "Nude with a hint of red", zh: "è£¸è‰²å¸¦ä¸€ä¸çº¢æ¶¦" },
          { en: "Soft rose tint", zh: "è½»æŸ”ç«ç‘°è‰²" },
          { en: "Blurred coral tint", zh: "æœ¦èƒ§çŠç‘šè‰²" }
        ],
        hands: [
          { en: "Both hands gently touching cheeks", zh: "åŒæ‰‹è½»è§¦è„¸é¢Š" },
          { en: "One hand touching cheek", zh: "å•æ‰‹è§¦è„¸" },
          { en: "Hands holding phone", zh: "æ‰‹æŒæ‰‹æœº" }
        ],
        expression: [
          { en: "Dreamy and slightly cheerful", zh: "è¿·ç¦»ä¸”å¾®å¾®æ„‰æ‚¦" },
          { en: "Soft smile", zh: "è½»æŸ”å¾®ç¬‘" },
          { en: "Calm and gentle", zh: "å¹³é™æ¸©æŸ”" }
        ],
        cameraAngle: [
          { en: "High-angle selfie, approx 30 degrees above the face", zh: "é«˜ä½è‡ªæ‹ï¼Œçº¦ 30Â° ä¿¯æ‹" },
          { en: "Eye-level selfie", zh: "è§†çº¿å¹³è§†è‡ªæ‹" },
          { en: "Low-angle subtle tilt", zh: "ä½è§’åº¦è½»å¾®å€¾æ–œ" }
        ],
        cameraType: [
          { en: "Analog 35mm camera flash", zh: "èƒ¶ç‰‡ 35mm é—ªå…‰" },
          { en: "Digital compact camera flash", zh: "æ•°ç å¡ç‰‡æœºé—ªå…‰" },
          { en: "Smartphone flash", zh: "æ‰‹æœºé—ªå…‰" }
        ],
        aspectRatio: [
          { value: "1:1", en: "1:1 Square", zh: "1:1 æ­£æ–¹å½¢" },
          { value: "3:4", en: "3:4 Portrait", zh: "3:4 ç«–å¹…" },
          { value: "2:3", en: "2:3 Classic portrait", zh: "2:3 ç»å…¸ç«–å¹…" },
          { value: "4:5", en: "4:5 Portrait", zh: "4:5 ç«–å¹…" },
          { value: "9:16", en: "9:16 Vertical", zh: "9:16 ç«–å±" },
          { value: "6:19", en: "6:19 Vertical", zh: "6:19 ç«–å¹…" }
        ],
        bgColor: [
          { en: "Dark wall with shallow depth, contrasting with flash lighting", zh: "æ·±è‰²å¢™é¢æµ…æ™¯æ·±ï¼Œä¸é—ªå…‰å½¢æˆå¯¹æ¯”" },
          { en: "Plain dark background with subtle texture", zh: "çº¯æ·±è‰²èƒŒæ™¯ï¼Œè½»å¾®çº¹ç†" },
          { en: "Matte charcoal wall, shallow depth", zh: "å“‘å…‰æœ¨ç‚­ç°å¢™é¢ï¼Œæµ…æ™¯æ·±" }
        ],
        bgEffect: [
          { en: "Minimalist, modern, friendly, with slight reflective highlights", zh: "æç®€ç°ä»£ï¼Œå‹å¥½æ°›å›´ï¼Œç•¥å¸¦åå…‰é«˜å…‰" },
          { en: "Minimalist background, soft texture", zh: "æç®€èƒŒæ™¯ï¼ŒæŸ”è½¯è´¨æ„Ÿ" },
          { en: "Clean modern backdrop, slight sheen", zh: "å¹²å‡€ç°ä»£èƒŒæ™¯ï¼Œå¾®å¾®å…‰æ³½" }
        ],
        lighting: [
          { en: "Cool dim light with flash highlighting the face, hair, skin, and clothing texture", zh: "å†·è‰²å¾®æš—ç¯å¢ƒï¼Œé—ªå…‰å¼ºè°ƒè„¸éƒ¨ã€å¤´å‘ã€è‚Œè‚¤ä¸é’ˆç»‡è´¨æ„Ÿ" },
          { en: "Low ambient light with strong flash contrast", zh: "ä½ç¯å¢ƒå…‰ï¼Œé—ªå…‰å¼ºå¯¹æ¯”" },
          { en: "Dim cool light, crisp flash", zh: "å¾®æš—å†·è‰²å…‰ï¼Œæ¸…æ™°é—ªå…‰" }
        ],
        mood: [
          { en: "Film noir elegance", zh: "é»‘è‰²ç”µå½±å¼ä¼˜é›…" },
          { en: "Cozy minimalism", zh: "æ¸©æš–æç®€" },
          { en: "Modern simplicity", zh: "ç°ä»£ç®€çº¦" }
        ]
      };
      const uiLabels = {
        groups: {
          hairStyle: { zh: "å¤´å‘é€ å‹", en: "Hair Style" },
          hairColor: { zh: "å‘è‰²", en: "Hair Color" },
          clothing: { zh: "æœé¥°ä¸é¥°å“", en: "Clothing & Accessories" },
          makeup: { zh: "å¦†å®¹", en: "Makeup" },
          pose: { zh: "å§¿æ€ä¸æœºä½", en: "Pose & Camera" },
          composition: { zh: "æ„å›¾æ¯”ä¾‹", en: "Composition" },
          background: { zh: "èƒŒæ™¯ä¸å…‰çº¿", en: "Background & Lighting" },
          style: { zh: "é£æ ¼", en: "Style" },
          camera: { zh: "ç›¸æœº", en: "Camera" }
        },
        subs: {
          top: { zh: "ä¸Šè¡£", en: "Top" },
          earrings: { zh: "è€³é¥°", en: "Earrings" },
          rings: { zh: "æˆ’æŒ‡", en: "Rings" },
          nails: { zh: "æŒ‡ç”²", en: "Nails" },
          makeupStyle: { zh: "å¦†å®¹é£æ ¼", en: "Makeup Style" },
          eyebrows: { zh: "çœ‰æ¯›", en: "Eyebrows" },
          eyeliner: { zh: "çœ¼çº¿", en: "Eyeliner" },
          eyelashes: { zh: "ç«æ¯›", en: "Eyelashes" },
          blush: { zh: "è…®çº¢", en: "Blush" },
          lips: { zh: "å”‡å¦†", en: "Lips" },
          hands: { zh: "æ‰‹éƒ¨åŠ¨ä½œ", en: "Hand Pose" },
          expression: { zh: "è¡¨æƒ…", en: "Expression" },
          cameraAngle: { zh: "æœºä½è§’åº¦", en: "Camera Angle" },
          aspectRatio: { zh: "ç”»é¢æ¯”ä¾‹", en: "Aspect Ratio" },
          bgColor: { zh: "èƒŒæ™¯è‰²/å¢™ä½“", en: "Background / Wall" },
          bgEffect: { zh: "èƒŒæ™¯æ•ˆæœ", en: "Background Effect" },
          lighting: { zh: "å…‰çº¿æ¡ä»¶", en: "Lighting Conditions" },
          mood: { zh: "é£æ ¼æ°›å›´", en: "Mood" },
          cameraType: { zh: "ç›¸æœºç±»å‹", en: "Camera Type" }
        }
      };
      const uiText = {
        title: { zh: "PromptPhoto æç¤ºè¯ç”Ÿæˆå™¨", en: "PromptPhoto Prompt Builder" },
        dimensionHeading: { zh: "ç»´åº¦é€‰æ‹©", en: "Dimension Picker" },
        modeDropdown: { zh: "ä¸‹æ‹‰æ¨¡å¼", en: "Dropdown Mode" },
        modeExpanded: { zh: "å±•å¼€æ¨¡å¼", en: "Expanded Mode" },
        random: { zh: "éšæœº", en: "Random" },
        copy: { zh: "å¤åˆ¶", en: "Copy" },
        copySuccess: { zh: "å·²å¤åˆ¶", en: "Copied" },
        outputHeading: { zh: "JSON è¾“å‡º", en: "JSON Output" },
        customAddTrigger: { zh: "æ·»åŠ ç»´åº¦", en: "Add Dimension" },
        customNameZhPlaceholder: { zh: "ç»´åº¦åç§°ï¼ˆä¸­æ–‡ï¼‰", en: "Dimension name (ZH)" },
        customNameEnPlaceholder: { zh: "ç»´åº¦åç§°ï¼ˆè‹±æ–‡ï¼‰", en: "Dimension name (EN)" },
        customOptionsPlaceholder: { zh: "æ¯è¡Œï¼šæŸ”å’Œå…‰çº¿ | Soft lighting", en: "Each line: Soft lighting | Translation" },
        customHint: { zh: "æ¯è¡Œä½¿ç”¨â€œä¸­æ–‡ | Englishâ€æ ¼å¼ã€‚", en: "Use â€œChinese | Englishâ€ per line." },
        customSave: { zh: "æ·»åŠ ç»´åº¦", en: "Add Dimension" },
        customSaveEdit: { zh: "ä¿å­˜æ›´æ”¹", en: "Save Changes" },
        customCancel: { zh: "å–æ¶ˆ", en: "Cancel" },
        customModalAddTitle: { zh: "æ·»åŠ ç»´åº¦", en: "Add Dimension" },
        customModalEditTitle: { zh: "ç¼–è¾‘ç»´åº¦", en: "Edit Dimension" },
        customModalClose: { zh: "å…³é—­", en: "Close" },
        customEdit: { zh: "ç¼–è¾‘", en: "Edit" },
        customDelete: { zh: "åˆ é™¤", en: "Delete" },
        customDeleteConfirm: { zh: "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰ç»´åº¦å—ï¼Ÿ", en: "Delete this custom dimension?" },
        customErrorName: { zh: "è¯·è¾“å…¥ç»´åº¦åç§°ã€‚", en: "Please enter a dimension name." },
        customErrorOptions: { zh: "è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªé€‰é¡¹ã€‚", en: "Please provide at least one option." },
        savedTitle: { zh: "é…ç½®ç¼“å­˜", en: "Saved Presets" },
        savedDelete: { zh: "åˆ é™¤", en: "Delete" },
        savedDeleteConfirm: { zh: "ç¡®å®šåˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ", en: "Delete this preset?" },
        savedErrorName: { zh: "è¯·è¾“å…¥é…ç½®åç§°ã€‚", en: "Please enter a name." },
        savedPanelToggle: { zh: "ä¿å­˜", en: "Save" },
        savedModalTitle: { zh: "ä¿å­˜å½“å‰é…ç½®", en: "Save Current Preset" },
        savedModalPlaceholder: { zh: "è¾“å…¥åç§°", en: "Preset name" },
        savedModalSave: { zh: "ä¿å­˜", en: "Save" },
        savedModalCancel: { zh: "å–æ¶ˆ", en: "Cancel" }
      };

      const els = {
        hairStyle: document.getElementById('hairStyle'),
        hairColor: document.getElementById('hairColor'),
        top: document.getElementById('top'),
        nails: document.getElementById('nails'),
        earrings: document.getElementById('earrings'),
        rings: document.getElementById('rings'),
        makeupStyle: document.getElementById('makeupStyle'),
        blush: document.getElementById('blush'),
        eyeliner: document.getElementById('eyeliner'),
        eyelashes: document.getElementById('eyelashes'),
        eyebrows: document.getElementById('eyebrows'),
        lips: document.getElementById('lips'),
        hands: document.getElementById('hands'),
        expression: document.getElementById('expression'),
        cameraAngle: document.getElementById('cameraAngle'),
        cameraType: document.getElementById('cameraType'),
        aspectRatio: document.getElementById('aspectRatio'),
        bgColor: document.getElementById('bgColor'),
        bgEffect: document.getElementById('bgEffect'),
        lighting: document.getElementById('lighting'),
        mood: document.getElementById('mood'),
        promptOutput: document.getElementById('promptOutput'),
        randomAll: document.getElementById('randomAll'),
        copyPrompt: document.getElementById('copyPrompt'),
        langZh: document.getElementById('lang-zh'),
        langEn: document.getElementById('lang-en'),
        appTitle: document.getElementById('appTitle'),
        dimensionHeading: document.getElementById('dimensionHeading'),
        outputHeading: document.getElementById('outputHeading'),
        randomLabel: document.getElementById('randomLabel'),
        copyLabel: document.getElementById('copyLabel'),
        customAddTrigger: document.getElementById('customAddTrigger'),
        customNameZh: document.getElementById('customNameZh'),
        customNameEn: document.getElementById('customNameEn'),
        customOptionsInput: document.getElementById('customOptionsInput'),
        customSaveBtn: document.getElementById('customSaveBtn'),
        customCancelBtn: document.getElementById('customCancelBtn'),
        customOptionsHint: document.getElementById('customOptionsHint'),
        customFormStatus: document.getElementById('customFormStatus'),
      customDimensionsContainer: document.getElementById('customDimensionsContainer'),
        savedConfigsTitle: document.getElementById('savedStripTitle'),
        savedStrip: document.getElementById('savedStrip'),
        savedStripList: document.getElementById('savedStripList'),
        savedPanelToggle: document.getElementById('savedPanelToggle'),
        saveLabel: document.getElementById('saveLabel'),
        presetModalOverlay: document.getElementById('presetModalOverlay'),
        presetModalInput: document.getElementById('presetModalInput'),
        presetModalSave: document.getElementById('presetModalSave'),
        presetModalCancel: document.getElementById('presetModalCancel'),
        presetModalTitle: document.getElementById('presetModalTitle'),
        customModalOverlay: document.getElementById('customModalOverlay'),
        customModalClose: document.getElementById('customModalClose'),
        customModalTitle: document.getElementById('customModalTitle'),
        groupHairStyle: document.getElementById('group-hair-style'),
        groupHairColor: document.getElementById('group-hair-color'),
        groupClothing: document.getElementById('group-clothing'),
        groupMakeup: document.getElementById('group-makeup'),
        groupPose: document.getElementById('group-pose'),
        groupComposition: document.getElementById('group-composition'),
        groupBackground: document.getElementById('group-background'),
        groupStyle: document.getElementById('group-style'),
        groupCamera: document.getElementById('group-camera'),
        modeToggle: document.getElementById('modeToggle')
      };
      const eyeIcons = {
        on: '<svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke-width="2"/></svg>',
        off: '<svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7c2.4 0 4.4.7 6 1.7M23 12s-4 7-11 7c-2.4 0-4.4-.7-6-1.7" stroke-width="2"/><path d="M3 3l18 18" stroke-width="2"/></svg>'
      };
      const lockIcons = {
        unlocked: '<svg viewBox="0 0 24 24"><path d="M7 10V8a5 5 0 0110 0v2" stroke-width="2"/><rect x="5" y="10" width="14" height="10" rx="2" stroke-width="2"/></svg>',
        locked: '<svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 018 0v2" stroke-width="2"/><rect x="5" y="10" width="14" height="10" rx="2" stroke-width="2"/></svg>'
      };
      function setVisibilityButtonState(btn, on) {
        if (!btn) return;
        btn.innerHTML = on ? eyeIcons.on : eyeIcons.off;
        btn.setAttribute('aria-pressed', String(!on));
      }
      const groupWraps = {
        hairStyle: els.groupHairStyle,
        hairColor: els.groupHairColor,
        clothing: els.groupClothing,
        makeup: els.groupMakeup,
        pose: els.groupPose,
        composition: els.groupComposition,
        background: els.groupBackground,
        style: els.groupStyle,
        camera: els.groupCamera
      };
      const groupOptionMap = {
        hairStyle: ['hairStyle'],
        hairColor: ['hairColor'],
        clothing: ['top', 'earrings', 'rings', 'nails'],
        makeup: ['makeupStyle', 'eyebrows', 'eyeliner', 'eyelashes', 'blush', 'lips'],
        pose: ['hands', 'expression', 'cameraAngle'],
        composition: ['aspectRatio'],
        background: ['bgColor', 'bgEffect', 'lighting'],
        style: ['mood'],
        camera: ['cameraType']
      };
      const subToGroupMap = Object.entries(groupOptionMap).reduce((acc, [groupKey, subKeys]) => {
        subKeys.forEach(subKey => { acc[subKey] = groupKey; });
        return acc;
      }, {});
      function setGroupStateByKey(groupKey, on) {
        const wrap = groupWraps[groupKey];
        if (wrap) wrap.classList.toggle('group-disabled', !on);
      }
      if (current.lang === 'en') {
        els.langEn.classList.add('active');
        els.langZh.classList.remove('active');
      }

      function renderOptions(el, list, currentIdx, key) {
        if (!el) return;
        const items = Array.isArray(list) ? list : [];
        el.innerHTML = '';
        if (!items.length) return;
        const numericIdx = Number(currentIdx);
        const safeIdx = Math.max(0, Math.min(items.length - 1, Number.isFinite(numericIdx) ? numericIdx : 0));
        const currentOption = items[safeIdx] || items[0];
        const currentLabel = currentOption ? (currentOption[current.lang] || currentOption.en || currentOption.value || '') : '';
        const isLocked = !!lockedSub[key];
        const isEnabled = enabledSub[key] !== false;
        const shouldShowAll = uiMode === 'expanded' && !isLocked;
        if (shouldShowAll) {
          items.forEach((v, i) => {
            const b = document.createElement('button');
            b.type = 'button';
            b.className = 'option' + (i === safeIdx ? ' active' : '');
            b.dataset.idx = i;
            b.textContent = v[current.lang] || v.en || v.value || '';
            if (!isEnabled) b.classList.add('disabled');
            el.appendChild(b);
          });
        } else {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'option active single-option' + (isLocked ? ' locked-view' : '');
          b.dataset.idx = safeIdx;
          if (!isLocked && uiMode !== 'expanded') {
            b.innerHTML = `${currentLabel} <span class="caret"><svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5" stroke-width="2"/></svg></span>`;
          } else {
            b.textContent = currentLabel;
          }
          if (!isEnabled || isLocked) b.classList.add('disabled');
          if (!isLocked && uiMode !== 'expanded' && isEnabled) {
            b.addEventListener('click', (e) => { if (isEnabled) openChipPopover(e.currentTarget, key); });
          }
          if (!isLocked) {
            el.appendChild(b);
          } else {
            const lockedWrap = document.createElement('div');
            lockedWrap.className = 'locked-chip';
            lockedWrap.appendChild(b);
            const inlineLock = document.createElement('button');
            inlineLock.type = 'button';
            inlineLock.className = 'option-lock-btn';
            inlineLock.innerHTML = lockIcons.unlocked;
            inlineLock.title = current.lang === 'zh' ? 'è§£é”' : 'Unlock';
            inlineLock.setAttribute('aria-label', inlineLock.title);
            inlineLock.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              const hasSubBtn = !!document.querySelector(`.lock-btn[data-sub="${key}"]`);
              if (hasSubBtn) {
                applySubLockState(key, false);
              } else {
                const parentGroup = subToGroupMap[key] || key;
                applyGroupLockState(parentGroup, false);
              }
            });
            lockedWrap.appendChild(inlineLock);
            el.appendChild(lockedWrap);
          }
        }
      }

      function renderCustomDimensions() {
        const container = els.customDimensionsContainer;
        if (!container) return;
        container.innerHTML = '';
        Object.keys(els).forEach(key => {
          if (key.startsWith('custom_')) delete els[key];
        });
        if (!customDimensions.length) return;
        customDimensions.forEach(dim => {
          const card = document.createElement('div');
          card.className = 'custom-dimension-card';
          const header = document.createElement('div');
          header.className = 'custom-dimension-header';
          const nameEl = document.createElement('div');
          nameEl.className = 'custom-dimension-name';
          nameEl.textContent = dim.name[current.lang] || dim.name.zh || dim.name.en;
          header.appendChild(nameEl);
          const actions = document.createElement('div');
          actions.className = 'custom-actions';
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'custom-text-btn';
          editBtn.textContent = uiText.customEdit[current.lang];
          editBtn.addEventListener('click', () => startEditingCustomDimension(dim.id));
          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'custom-text-btn';
          deleteBtn.textContent = uiText.customDelete[current.lang];
          deleteBtn.addEventListener('click', () => deleteCustomDimension(dim.id));
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          header.appendChild(actions);
          card.appendChild(header);
          const optWrap = document.createElement('div');
          optWrap.className = 'options options-block';
          optWrap.id = dim.key;
          card.appendChild(optWrap);
          container.appendChild(card);
          els[dim.key] = optWrap;
          renderOptions(optWrap, options[dim.key] || [], state[dim.key] || 0, dim.key);
          bindOptionContainer(optWrap, dim.key);
        });
      }

      function renderSavedConfigsList() {
        const container = els.savedStripList;
        if (!container) return;
        container.innerHTML = '';
        const hasPresets = savedConfigs.length > 0;
        if (els.savedStrip) els.savedStrip.classList.toggle('hidden', !hasPresets);
        if (!hasPresets) return;
        savedConfigs.forEach(cfg => {
          const item = document.createElement('div');
          item.className = 'saved-strip-item' + (cfg.id === activeSavedConfigId ? ' active' : '');
          item.tabIndex = 0;
          item.setAttribute('role', 'button');
          const nameEl = document.createElement('span');
          nameEl.className = 'saved-strip-item-name';
          nameEl.textContent = cfg.name;
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.textContent = 'Ã—';
          const label = uiText.savedDelete[current.lang];
          delBtn.setAttribute('aria-label', label);
          delBtn.title = label;
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteSavedConfig(cfg.id);
          });
          item.addEventListener('click', () => loadSavedConfig(cfg.id));
          item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              loadSavedConfig(cfg.id);
            }
          });
          item.appendChild(nameEl);
          item.appendChild(delBtn);
          container.appendChild(item);
        });
      }
      function openSaveModal() {
        if (els.presetModalOverlay) els.presetModalOverlay.classList.remove('hidden');
        if (els.presetModalInput) {
          els.presetModalInput.value = '';
          setTimeout(() => els.presetModalInput?.focus(), 0);
        }
      }
      function closeSaveModal() {
        if (els.presetModalOverlay) els.presetModalOverlay.classList.add('hidden');
      }

      function replaceMap(target, fallback, incoming) {
        Object.keys(target).forEach(key => { delete target[key]; });
        if (fallback && typeof fallback === 'object') Object.assign(target, fallback);
        if (incoming && typeof incoming === 'object') Object.assign(target, incoming);
      }
      function applyPresetSnapshot(snapshot) {
        if (!snapshot) return;
        replaceMap(state, defaultState, snapshot.state);
        replaceMap(enabled, defaultEnabled, snapshot.enabled);
        replaceMap(enabledSub, defaultEnabledSub, snapshot.enabledSub);
        replaceMap(locked, defaultLocked, snapshot.locked);
        replaceMap(lockedSub, defaultLockedSub, snapshot.lockedSub);
        syncCustomData();
      }
      function captureCurrentSnapshot() {
        return {
          state: { ...state },
          enabled: { ...enabled },
          enabledSub: { ...enabledSub },
          locked: { ...locked },
          lockedSub: { ...lockedSub }
        };
      }
      function shallowEqualMap(a = {}, b = {}) {
        const keys = new Set([...(Object.keys(a || {})), ...(Object.keys(b || {}))]);
        for (const key of keys) {
          if ((a || {})[key] !== (b || {})[key]) return false;
        }
        return true;
      }
      function snapshotsEqual(a, b) {
        if (!a || !b) return false;
        return shallowEqualMap(a.state, b.state)
          && shallowEqualMap(a.enabled, b.enabled)
          && shallowEqualMap(a.enabledSub, b.enabledSub)
          && shallowEqualMap(a.locked, b.locked)
          && shallowEqualMap(a.lockedSub, b.lockedSub);
      }
      function maybeResetActivePreset() {
        if (!activeSavedConfigId) return;
        const preset = savedConfigs.find(cfg => cfg.id === activeSavedConfigId);
        if (!preset) {
          activeSavedConfigId = null;
          renderSavedConfigsList();
          return;
        }
        const currentSnapshot = captureCurrentSnapshot();
        if (!snapshotsEqual(currentSnapshot, preset.snapshot)) {
          activeSavedConfigId = null;
          renderSavedConfigsList();
        }
      }
      function handleSavePreset() {
        if (!els.presetModalInput) return;
        const rawName = els.presetModalInput.value.trim();
        if (!rawName) {
          window.alert(uiText.savedErrorName[current.lang]);
          els.presetModalInput.focus();
          return;
        }
        const existingIdx = savedConfigs.findIndex(cfg => cfg.name === rawName);
        const payload = {
          id: existingIdx >= 0 ? savedConfigs[existingIdx].id : createPresetId(),
          name: rawName,
          snapshot: captureCurrentSnapshot(),
          updatedAt: Date.now()
        };
        if (existingIdx >= 0) {
          savedConfigs.splice(existingIdx, 1);
          savedConfigs.unshift(payload);
        } else {
          savedConfigs.unshift(payload);
        }
        activeSavedConfigId = payload.id;
        closeSaveModal();
        renderSavedConfigsList();
        persistCurrentState();
      }
      function deleteSavedConfig(id) {
        const idx = savedConfigs.findIndex(cfg => cfg.id === id);
        if (idx < 0) return;
        const confirmMsg = uiText.savedDeleteConfirm[current.lang];
        if (confirmMsg && !window.confirm(confirmMsg)) return;
        const [removed] = savedConfigs.splice(idx, 1);
        if (removed && removed.id === activeSavedConfigId) activeSavedConfigId = null;
        renderSavedConfigsList();
        persistCurrentState();
      }
      function loadSavedConfig(id) {
        const preset = savedConfigs.find(cfg => cfg.id === id);
        if (!preset) return;
        applyPresetSnapshot(preset.snapshot);
        activeSavedConfigId = id;
        init();
      }

      function updateModeToggleLabel() {
        if (!els.modeToggle) return;
        els.modeToggle.textContent = uiMode === 'dropdown' ? uiText.modeDropdown[current.lang] : uiText.modeExpanded[current.lang];
      }

      function updateCustomFormLabels() {
        if (els.customAddTrigger) els.customAddTrigger.textContent = uiText.customAddTrigger[current.lang];
        if (els.customNameZh) els.customNameZh.placeholder = uiText.customNameZhPlaceholder[current.lang];
        if (els.customNameEn) els.customNameEn.placeholder = uiText.customNameEnPlaceholder[current.lang];
        if (els.customOptionsInput) els.customOptionsInput.placeholder = uiText.customOptionsPlaceholder[current.lang];
        if (els.customOptionsHint) els.customOptionsHint.textContent = uiText.customHint[current.lang];
        if (els.customSaveBtn) els.customSaveBtn.textContent = editingCustomId ? uiText.customSaveEdit[current.lang] : uiText.customSave[current.lang];
        if (els.customModalTitle) {
          const titleKey = editingCustomId ? 'customModalEditTitle' : 'customModalAddTitle';
          els.customModalTitle.textContent = uiText[titleKey][current.lang];
        }
        if (els.customModalClose) {
          const label = uiText.customModalClose[current.lang];
          els.customModalClose.setAttribute('aria-label', label);
          els.customModalClose.title = label;
        }
        if (els.customCancelBtn) els.customCancelBtn.textContent = uiText.customCancel[current.lang];
      }

      function applyLabels() {
        document.querySelectorAll('.group-title').forEach(el => {
          const key = el.dataset.group;
          if (!key) return;
          const label = uiLabels.groups[key]?.[current.lang];
          if (label) el.textContent = label;
        });
        document.querySelectorAll('.sub-title').forEach(el => {
          const key = el.dataset.sub;
          if (!key) return;
          const label = uiLabels.subs[key]?.[current.lang];
          if (label) el.textContent = label;
        });
        if (els.appTitle) els.appTitle.textContent = uiText.title[current.lang];
        if (els.dimensionHeading) els.dimensionHeading.textContent = uiText.dimensionHeading[current.lang];
        if (els.outputHeading) els.outputHeading.textContent = uiText.outputHeading[current.lang];
        if (els.randomLabel) els.randomLabel.textContent = uiText.random[current.lang];
        if (els.copyLabel) {
          const copyKey = els.copyPrompt?.classList.contains('copied') ? 'copySuccess' : 'copy';
          els.copyLabel.textContent = uiText[copyKey][current.lang];
        }
        if (els.saveLabel) els.saveLabel.textContent = uiText.savedPanelToggle[current.lang];
        if (els.savedConfigsTitle) els.savedConfigsTitle.textContent = uiText.savedTitle[current.lang];
        if (els.presetModalTitle) els.presetModalTitle.textContent = uiText.savedModalTitle[current.lang];
        if (els.presetModalInput) els.presetModalInput.placeholder = uiText.savedModalPlaceholder[current.lang];
        if (els.presetModalSave) els.presetModalSave.textContent = uiText.savedModalSave[current.lang];
        if (els.presetModalCancel) els.presetModalCancel.textContent = uiText.savedModalCancel[current.lang];
        updateModeToggleLabel();
        updateCustomFormLabels();
      }

      function findIdx(list, matchValue) {
        if (!Array.isArray(list) || list.length === 0) return 0;
        if (!matchValue) return 0;
        const byValue = list.findIndex(v => v.value === matchValue);
        if (byValue >= 0) return byValue;
        return Math.max(0, list.findIndex(v => v.en === matchValue));
      }
      const state = {
        hairStyle: findIdx(options.hairStyle, defaults.hair.style),
        hairColor: findIdx(options.hairColor, defaults.hair.color),
        top: findIdx(options.top, defaults.clothing.top),
        nails: findIdx(options.nails, defaults.clothing.nails),
        earrings: findIdx(options.earrings, defaults.clothing.accessories.earrings),
        rings: findIdx(options.rings, defaults.clothing.accessories.rings),
        makeupStyle: findIdx(options.makeupStyle, defaults.makeup.style),
        blush: findIdx(options.blush, defaults.makeup.details.blush),
        eyeliner: findIdx(options.eyeliner, defaults.makeup.details.eyeliner),
        eyelashes: findIdx(options.eyelashes, defaults.makeup.details.eyelashes),
        eyebrows: findIdx(options.eyebrows, defaults.makeup.details.eyebrows),
        lips: findIdx(options.lips, defaults.makeup.details.lips),
        hands: findIdx(options.hands, defaults.pose.hands),
        expression: findIdx(options.expression, defaults.pose.expression),
        cameraAngle: findIdx(options.cameraAngle, defaults.pose.camera_angle),
        cameraType: findIdx(options.cameraType, defaults.camera.type),
        aspectRatio: findIdx(options.aspectRatio, defaults.composition.aspect_ratio),
        bgColor: findIdx(options.bgColor, defaults.background.color),
        bgEffect: findIdx(options.bgEffect, defaults.background.effect),
        lighting: findIdx(options.lighting, defaults.background.lighting),
        mood: findIdx(options.mood, defaults.style.mood)
      };
      const defaultState = { ...state };
      if (savedData?.state) Object.assign(state, savedData.state);
      const enabled = {
        hairStyle: true,
        hairColor: true,
        clothing: true,
        makeup: true,
        pose: true,
        composition: true,
        background: true,
        style: true,
        camera: true
      };
      const defaultEnabled = { ...enabled };
      if (savedData?.enabled) Object.assign(enabled, savedData.enabled);
      Object.keys(groupWraps).forEach(key => setGroupStateByKey(key, enabled[key]));
      const locked = {
        hairStyle: false,
        hairColor: false,
        clothing: false,
        makeup: false,
        pose: false,
        composition: false,
        background: false,
        style: false,
        camera: false
      };
      const defaultLocked = { ...locked };
      if (savedData?.locked) Object.assign(locked, savedData.locked);
      Object.keys(locked).forEach(key => {
        const wrap = groupWraps[key];
        if (wrap) wrap.classList.toggle('group-locked', !!locked[key]);
      });
      const enabledSub = {
        top: true, earrings: true, rings: true, nails: true,
        makeupStyle: true, eyebrows: true, eyeliner: true, eyelashes: true, blush: true, lips: true,
        hands: true, expression: true, cameraAngle: true,
        aspectRatio: true,
        bgColor: true, bgEffect: true, lighting: true,
        mood: true, cameraType: true,
        hairStyle: true, hairColor: true
      };
      const defaultEnabledSub = { ...enabledSub };
      if (savedData?.enabledSub) Object.assign(enabledSub, savedData.enabledSub);
      const lockedSub = {
        top: false, earrings: false, rings: false, nails: false,
        makeupStyle: false, eyebrows: false, eyeliner: false, eyelashes: false, blush: false, lips: false,
        hands: false, expression: false, cameraAngle: false,
        aspectRatio: false,
        bgColor: false, bgEffect: false, lighting: false,
        mood: false, cameraType: false,
        hairStyle: false, hairColor: false
      };
      const defaultLockedSub = { ...lockedSub };
      if (savedData?.lockedSub) Object.assign(lockedSub, savedData.lockedSub);
      function setLockButtonState(btn, isLocked) {
        if (!btn) return;
        btn.classList.toggle('locked', !!isLocked);
        btn.innerHTML = isLocked ? lockIcons.locked : lockIcons.unlocked;
        btn.setAttribute('aria-pressed', String(!!isLocked));
      }
      function refreshOptionsForKey(key) {
        const container = els[key] || document.getElementById(key);
        if (!container || !options[key]) return;
        renderOptions(container, options[key], state[key], key);
      }
      function syncGroupLockFromSubs(groupKey) {
        if (!(groupKey in locked)) return;
        const subKeys = groupOptionMap[groupKey] || [];
        if (!subKeys.length) return;
        const allLocked = subKeys.every(subKey => lockedSub[subKey]);
        if (locked[groupKey] !== allLocked) {
          locked[groupKey] = allLocked;
          const groupBtn = document.querySelector(`.lock-btn[data-group="${groupKey}"]`);
          setLockButtonState(groupBtn, allLocked);
          const wrap = groupWraps[groupKey];
          if (wrap) wrap.classList.toggle('group-locked', allLocked);
        }
      }
      function applySubLockState(subKey, isLocked, opts = {}) {
        if (!(subKey in lockedSub)) return;
        lockedSub[subKey] = !!isLocked;
        const subBtn = document.querySelector(`.lock-btn[data-sub="${subKey}"]`);
        setLockButtonState(subBtn, lockedSub[subKey]);
        refreshOptionsForKey(subKey);
        setSubStateByKey(subKey);
        const parentGroup = subToGroupMap[subKey];
        if (!opts.skipSync && parentGroup) syncGroupLockFromSubs(parentGroup);
        if (!opts.skipPersist) persistCurrentState();
      }
      function applyGroupLockState(groupKey, isLocked, opts = {}) {
        if (!(groupKey in locked)) return;
        locked[groupKey] = !!isLocked;
        const groupBtn = document.querySelector(`.lock-btn[data-group="${groupKey}"]`);
        setLockButtonState(groupBtn, locked[groupKey]);
        const wrap = groupWraps[groupKey];
        if (wrap) wrap.classList.toggle('group-locked', locked[groupKey]);
        const subKeys = groupOptionMap[groupKey] || [];
        subKeys.forEach(subKey => {
          applySubLockState(subKey, locked[groupKey], { skipPersist: true, skipSync: true });
        });
        syncGroupLockFromSubs(groupKey);
        if (!opts.skipPersist) persistCurrentState();
      }
      function setSubStateByKey(subKey) {
        if (!subKey) return;
        const isEnabled = enabledSub[subKey] !== false;
        const isLocked = !!lockedSub[subKey];
        const titleEl = document.querySelector(`.sub-title[data-sub="${subKey}"]`);
        const row = titleEl ? titleEl.closest('.sub-title-row') : null;
        if (row) {
          row.classList.toggle('sub-disabled', !isEnabled);
          row.classList.toggle('sub-locked', isLocked);
        }
        const wrap = document.getElementById(subKey);
        if (wrap) {
          wrap.classList.toggle('sub-disabled', !isEnabled);
          wrap.classList.toggle('sub-locked', isLocked);
          wrap.querySelectorAll('.option').forEach(btn => btn.classList.toggle('disabled', !isEnabled || isLocked));
        }
        const visBtn = document.querySelector(`.visibility-btn[data-sub="${subKey}"]`);
        setVisibilityButtonState(visBtn, isEnabled);
      }
      const collapsedGroups = {};
      const collapsedSub = {};
      const optionListenerElements = new WeakSet();
      function bindOptionContainer(el, key) {
        if (!el || optionListenerElements.has(el)) return;
        el.addEventListener('click', e => {
          const t = e.target;
          if (!t.classList.contains('option')) return;
          if (uiMode !== 'expanded') return;
          if (!enabledSub[key] || lockedSub[key]) return;
          const v = Number(t.dataset.idx);
          state[key] = v;
          el.querySelectorAll('.option').forEach(btn => btn.classList.remove('active'));
          t.classList.add('active');
          composeAndRender();
        });
        optionListenerElements.add(el);
      }
      function parseCustomOptionsText(text) {
        return (text || '').split('\n').map(line => line.trim()).filter(Boolean).map(line => {
          const parts = line.split('|').map(v => v.trim()).filter(Boolean);
          const zh = parts[0] || '';
          const en = parts[1] || zh;
          return { zh, en };
        });
      }
      function createPresetId() {
        return `preset_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
      }
      function cloneSnapshotSection(value) {
        return value && typeof value === 'object' ? { ...value } : {};
      }
      function normalizeSavedConfigs(list) {
        if (!Array.isArray(list)) return [];
        return list.map(entry => {
          if (!entry || typeof entry !== 'object') return null;
          const name = (entry.name || '').trim();
          if (!name) return null;
          const snapshot = entry.snapshot && typeof entry.snapshot === 'object' ? entry.snapshot : {};
          return {
            id: entry.id || createPresetId(),
            name,
            snapshot: {
              state: cloneSnapshotSection(snapshot.state),
              enabled: cloneSnapshotSection(snapshot.enabled),
              enabledSub: cloneSnapshotSection(snapshot.enabledSub),
              locked: cloneSnapshotSection(snapshot.locked),
              lockedSub: cloneSnapshotSection(snapshot.lockedSub)
            },
            updatedAt: typeof entry.updatedAt === 'number' ? entry.updatedAt : Date.now()
          };
        }).filter(Boolean);
      }
      function syncCustomData() {
        customDimensions = (customDimensions || []).map(dim => {
          const id = dim.id || String(Date.now() + Math.random());
          const key = dim.key || `custom_${id}`;
          const name = dim.name || {};
          const zhName = name.zh || dim.labelZh || '';
          const enName = name.en || dim.labelEn || zhName;
          const optionArray = Array.isArray(dim.options) ? dim.options : [];
          const rawTextFallback = optionArray.map(opt => {
            if (!opt) return '';
            const zh = opt.zh || '';
            const en = opt.en && opt.en !== zh ? ` | ${opt.en}` : '';
            return `${zh}${en}`;
          }).filter(Boolean).join('\n');
          const rawText = dim.rawText ?? dim.optionsText ?? rawTextFallback;
          const optionsList = parseCustomOptionsText(rawText);
          return { id, key, name: { zh: zhName, en: enName }, rawText, options: optionsList };
        });
        customDimensions.forEach(dim => {
          options[dim.key] = dim.options;
          if (!(dim.key in state)) state[dim.key] = 0;
          if (!(dim.key in enabledSub)) enabledSub[dim.key] = true;
          if (!(dim.key in lockedSub)) lockedSub[dim.key] = false;
        });
        Object.keys(state).forEach(key => {
          if (key.startsWith('custom_') && !customDimensions.some(dim => dim.key === key)) {
            delete state[key];
          }
        });
        Object.keys(enabledSub).forEach(key => {
          if (key.startsWith('custom_') && !customDimensions.some(dim => dim.key === key)) delete enabledSub[key];
        });
        Object.keys(lockedSub).forEach(key => {
          if (key.startsWith('custom_') && !customDimensions.some(dim => dim.key === key)) delete lockedSub[key];
        });
        Object.keys(options).forEach(key => {
          if (key.startsWith('custom_') && !customDimensions.some(dim => dim.key === key)) {
            delete options[key];
          }
        });
      }
      syncCustomData();
      function init() {
        renderOptions(els.hairStyle, options.hairStyle, state.hairStyle, 'hairStyle');
        renderOptions(els.hairColor, options.hairColor, state.hairColor, 'hairColor');
        renderOptions(els.top, options.top, state.top, 'top');
        renderOptions(els.nails, options.nails, state.nails, 'nails');
        renderOptions(els.earrings, options.earrings, state.earrings, 'earrings');
        renderOptions(els.rings, options.rings, state.rings, 'rings');
        renderOptions(els.makeupStyle, options.makeupStyle, state.makeupStyle, 'makeupStyle');
        renderOptions(els.blush, options.blush, state.blush, 'blush');
        renderOptions(els.eyeliner, options.eyeliner, state.eyeliner, 'eyeliner');
        renderOptions(els.eyelashes, options.eyelashes, state.eyelashes, 'eyelashes');
        renderOptions(els.eyebrows, options.eyebrows, state.eyebrows, 'eyebrows');
        renderOptions(els.lips, options.lips, state.lips, 'lips');
        renderOptions(els.hands, options.hands, state.hands, 'hands');
        renderOptions(els.expression, options.expression, state.expression, 'expression');
        renderOptions(els.cameraAngle, options.cameraAngle, state.cameraAngle, 'cameraAngle');
        renderOptions(els.cameraType, options.cameraType, state.cameraType, 'cameraType');
        renderOptions(els.aspectRatio, options.aspectRatio, state.aspectRatio, 'aspectRatio');
        renderOptions(els.bgColor, options.bgColor, state.bgColor, 'bgColor');
        renderOptions(els.bgEffect, options.bgEffect, state.bgEffect, 'bgEffect');
        renderOptions(els.lighting, options.lighting, state.lighting, 'lighting');
        renderOptions(els.mood, options.mood, state.mood, 'mood');
        renderCustomDimensions();
        Object.keys(enabledSub).forEach(key => setSubStateByKey(key));
        renderSavedConfigsList();
        applyLabels();
        composeAndRender();
      }

      function pick(list, idx) {
        if (!Array.isArray(list) || list.length === 0) return '';
        const opt = list[idx] ?? list[0];
        if (!opt) return '';
        return opt.value || opt[current.lang];
      }
      function getState() {
        return {
          hairStyle: pick(options.hairStyle, state.hairStyle),
          hairColor: pick(options.hairColor, state.hairColor),
          top: pick(options.top, state.top),
          nails: pick(options.nails, state.nails),
          earrings: pick(options.earrings, state.earrings),
          rings: pick(options.rings, state.rings),
          makeupStyle: pick(options.makeupStyle, state.makeupStyle),
          blush: pick(options.blush, state.blush),
          eyeliner: pick(options.eyeliner, state.eyeliner),
          eyelashes: pick(options.eyelashes, state.eyelashes),
          eyebrows: pick(options.eyebrows, state.eyebrows),
          lips: pick(options.lips, state.lips),
          hands: pick(options.hands, state.hands),
          expression: pick(options.expression, state.expression),
          cameraAngle: pick(options.cameraAngle, state.cameraAngle),
          cameraType: pick(options.cameraType, state.cameraType),
          aspectRatio: pick(options.aspectRatio, state.aspectRatio),
          bgColor: pick(options.bgColor, state.bgColor),
          bgEffect: pick(options.bgEffect, state.bgEffect),
          lighting: pick(options.lighting, state.lighting),
          mood: pick(options.mood, state.mood),
          description: descriptions[current.lang],
          lightingCondition: defaults.camera.lighting_condition
        };
      }

      function composeJsonObject(s) {
        const obj = {
          description: s.description,
          style: { mood: s.mood }
        };
        if (enabled.hairStyle || enabled.hairColor) {
          obj.hair = {};
          if (enabled.hairStyle && enabledSub.hairStyle) obj.hair.style = s.hairStyle;
          if (enabled.hairColor && enabledSub.hairColor) obj.hair.color = s.hairColor;
        }
        if (enabled.clothing) {
          obj.clothing = {};
          if (enabledSub.top) obj.clothing.top = s.top;
          obj.clothing.accessories = {};
          if (enabledSub.earrings) obj.clothing.accessories.earrings = s.earrings;
          if (enabledSub.rings) obj.clothing.accessories.rings = s.rings;
          if (enabledSub.nails) obj.clothing.nails = s.nails;
        }
        if (enabled.makeup) {
          obj.makeup = { style: enabledSub.makeupStyle ? s.makeupStyle : undefined, details: {} };
          if (enabledSub.eyebrows) obj.makeup.details.eyebrows = s.eyebrows;
          if (enabledSub.eyeliner) obj.makeup.details.eyeliner = s.eyeliner;
          if (enabledSub.eyelashes) obj.makeup.details.eyelashes = s.eyelashes;
          if (enabledSub.blush) obj.makeup.details.blush = s.blush;
          if (enabledSub.lips) obj.makeup.details.lips = s.lips;
          if (Object.keys(obj.makeup.details).length === 0) delete obj.makeup.details;
          if (!obj.makeup.style) delete obj.makeup.style;
        }
        if (enabled.pose) {
          obj.pose = {};
          if (enabledSub.hands) obj.pose.hands = s.hands;
          if (enabledSub.expression) obj.pose.expression = s.expression;
          if (enabledSub.cameraAngle) obj.pose.camera_angle = s.cameraAngle;
        }
        if (enabled.composition) {
          obj.composition = {};
          if (enabledSub.aspectRatio) obj.composition.aspect_ratio = s.aspectRatio;
          if (!Object.keys(obj.composition).length) delete obj.composition;
        }
        if (enabled.background) {
          obj.background = {};
          if (enabledSub.bgColor) obj.background.color = s.bgColor;
          if (enabledSub.lighting) obj.background.lighting = s.lighting;
          if (enabledSub.bgEffect) obj.background.effect = s.bgEffect;
        }
        if (enabled.style) {
          obj.style = {};
          if (enabledSub.mood) obj.style.mood = s.mood;
        }
        if (enabled.camera) {
          obj.camera = {};
          if (enabledSub.cameraType) obj.camera.type = s.cameraType;
        }
        if (customDimensions.length) {
          obj.custom_dimensions = customDimensions.map(dim => {
            const entries = options[dim.key] || [];
            const sel = entries[state[dim.key]] || entries[0] || {};
            const valueZh = sel.zh || '';
            const valueEn = sel.en || sel.zh || '';
            return {
              key: dim.key,
              name_zh: dim.name.zh,
              name_en: dim.name.en || dim.name.zh,
              value_zh: valueZh,
              value_en: valueEn
            };
          });
        }
        return obj;
      }

      function composeAndRender() {
        const s = getState();
        const obj = composeJsonObject(s);
        els.promptOutput.textContent = JSON.stringify(obj, null, 2);
        maybeResetActivePreset();
        persistCurrentState();
      }

      function persistCurrentState() {
        const snapshot = {
          state,
          enabled,
          enabledSub,
          locked,
          lockedSub,
          customDimensions,
          savedConfigs,
          activeSavedConfigId,
          uiMode,
          currentLang: current.lang
        };
        saveToStorage(snapshot);
      }

      let chipPopover = null;
      let chipPopoverOutsideHandler = null;
      function openChipPopover(target, key) {
        closeChipPopover();
        const menu = document.createElement('div');
        menu.className = 'popover';
        const ul = document.createElement('ul');
        const list = options[key] || [];
        list.forEach((opt, idx) => {
          const li = document.createElement('li');
          li.textContent = opt[current.lang];
          li.addEventListener('click', () => {
            state[key] = idx;
            composeAndRender();
            init();
            closeChipPopover();
          });
          ul.appendChild(li);
        });
        menu.appendChild(ul);
        document.body.appendChild(menu);
        const rect = target.getBoundingClientRect();
        menu.style.top = `${rect.bottom + window.scrollY + 8}px`;
        menu.style.left = `${rect.left + window.scrollX}px`;
        chipPopover = menu;
        chipPopoverOutsideHandler = (e) => {
          const isClickInsidePopover = chipPopover && chipPopover.contains(e.target);
          const isTrigger = target.contains(e.target);
          if (!isClickInsidePopover && !isTrigger) {
            closeChipPopover();
          }
        };
        setTimeout(() => { document.addEventListener('click', chipPopoverOutsideHandler); }, 0);
      }
      function closeChipPopover() {
        if (chipPopover) {
          chipPopover.remove();
          chipPopover = null;
        }
        if (chipPopoverOutsideHandler) {
          document.removeEventListener('click', chipPopoverOutsideHandler);
          chipPopoverOutsideHandler = null;
        }
      }

      function randomAllVisible() {
        Object.entries(groupOptionMap).forEach(([group, keys]) => {
          if (!enabled[group] || locked[group]) return;
          keys.forEach(k => {
            if (!enabledSub[k] || lockedSub[k]) return;
            const list = options[k];
            const idx = Math.floor(Math.random()*list.length);
            state[k] = idx;
            const el = els[k];
            if (el) {
              const chipOptions = el.querySelectorAll('.option');
              if (chipOptions.length && uiMode === 'expanded') {
                chipOptions.forEach(btn => {
                  btn.classList.toggle('active', Number(btn.dataset.idx) === idx);
                });
              } else {
                const sel = el.querySelector('select');
                if (sel) sel.value = String(idx);
              }
            }
          });
        });
        customDimensions.forEach(dim => {
          const key = dim.key;
          if (!enabledSub[key] || lockedSub[key]) return;
          const list = options[key];
          if (!list || !list.length) return;
          state[key] = Math.floor(Math.random()*list.length);
        });
        if (uiMode === 'dropdown') {
          closeChipPopover();
          init();
        } else {
          composeAndRender();
        }
      }

      function showCopyFeedback() {
        if (!els.copyPrompt) return;
        els.copyPrompt.classList.add('copied');
        if (els.copyLabel) els.copyLabel.textContent = uiText.copySuccess[current.lang];
        if (copyFeedbackTimer) clearTimeout(copyFeedbackTimer);
        copyFeedbackTimer = setTimeout(() => {
          els.copyPrompt?.classList.remove('copied');
          if (els.copyLabel) els.copyLabel.textContent = uiText.copy[current.lang];
        }, 1600);
      }

      function getCustomFormValues() {
        return {
          zh: (els.customNameZh?.value || '').trim(),
          en: (els.customNameEn?.value || '').trim(),
          rawText: (els.customOptionsInput?.value || '').trim()
        };
      }
      function showCustomStatus(msg) {
        if (els.customFormStatus) els.customFormStatus.textContent = msg || '';
      }
      function resetCustomForm() {
        editingCustomId = null;
        if (els.customNameZh) els.customNameZh.value = '';
        if (els.customNameEn) els.customNameEn.value = '';
        if (els.customOptionsInput) els.customOptionsInput.value = '';
        showCustomStatus('');
        updateCustomFormLabels();
      }
      function openCustomModal() {
        if (els.customModalOverlay) {
          els.customModalOverlay.classList.remove('hidden');
          document.body.classList.add('modal-open');
        }
        setTimeout(() => { els.customNameZh?.focus(); }, 20);
      }
      function closeCustomModal() {
        if (els.customModalOverlay) {
          els.customModalOverlay.classList.add('hidden');
        }
        document.body.classList.remove('modal-open');
        resetCustomForm();
      }
      function startEditingCustomDimension(id) {
        const dim = customDimensions.find(d => d.id === id);
        if (!dim) return;
        editingCustomId = id;
        if (els.customNameZh) els.customNameZh.value = dim.name.zh || '';
        if (els.customNameEn) els.customNameEn.value = dim.name.en || '';
        if (els.customOptionsInput) els.customOptionsInput.value = dim.rawText || '';
        showCustomStatus('');
        updateCustomFormLabels();
        openCustomModal();
      }
      function deleteCustomDimension(id) {
        if (!customDimensions.some(dim => dim.id === id)) return;
        const confirmText = uiText.customDeleteConfirm[current.lang];
        if (confirmText && !window.confirm(confirmText)) return;
        customDimensions = customDimensions.filter(dim => dim.id !== id);
        syncCustomData();
        closeCustomModal();
        init();
        persistCurrentState();
      }
      function handleCustomSave() {
        const { zh, en, rawText } = getCustomFormValues();
        const lang = current.lang;
        if (!zh) { showCustomStatus(uiText.customErrorName[lang]); return; }
        const optionsList = parseCustomOptionsText(rawText);
        if (!optionsList.length) { showCustomStatus(uiText.customErrorOptions[lang]); return; }
        const payload = {
          id: editingCustomId || String(Date.now()),
          name: { zh, en: en || zh },
          rawText
        };
        if (editingCustomId) {
          customDimensions = customDimensions.map(dim => dim.id === editingCustomId ? payload : dim);
        } else {
          customDimensions.push(payload);
        }
        syncCustomData();
        closeCustomModal();
        init();
        persistCurrentState();
      }

      function bindClicks() {
        Object.entries(els).forEach(([k, el]) => {
          if (!options[k]) return;
          bindOptionContainer(el, k);
        });
        els.langZh.addEventListener('click', () => { current.lang = 'zh'; updateLangClass(); els.langZh.classList.add('active'); els.langEn.classList.remove('active'); init(); composeAndRender(); });
        els.langEn.addEventListener('click', () => { current.lang = 'en'; updateLangClass(); els.langEn.classList.add('active'); els.langZh.classList.remove('active'); init(); composeAndRender(); });
        document.querySelectorAll('.visibility-btn').forEach(btn => {
          const g = btn.dataset.group;
          const subKey = btn.dataset.sub;
          if (g) setVisibilityButtonState(btn, enabled[g]);
          if (subKey) setVisibilityButtonState(btn, enabledSub[subKey]);
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            if (g) {
              enabled[g] = !enabled[g];
              setGroupStateByKey(g, enabled[g]);
              setVisibilityButtonState(btn, enabled[g]);
            } else if (subKey) {
              enabledSub[subKey] = !enabledSub[subKey];
              setSubStateByKey(subKey);
            }
            composeAndRender();
          });
        });
        document.querySelectorAll('.collapse-btn').forEach(btn => {
          const g = btn.dataset.group;
          if (!g) return;
          if (!(g in collapsedGroups)) collapsedGroups[g] = false;
          const applyState = (collapsed) => {
            collapsedGroups[g] = collapsed;
            const wrap = groupWraps[g];
            if (wrap) wrap.classList.toggle('collapsed', collapsed);
            btn.classList.toggle('collapsed', collapsed);
            btn.setAttribute('aria-expanded', String(!collapsed));
          };
          applyState(collapsedGroups[g]);
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            applyState(!collapsedGroups[g]);
          });
        });
        document.querySelectorAll('.sub-collapse').forEach(btn => {
          const key = btn.dataset.subTarget;
          if (!key) return;
          if (!(key in collapsedSub)) collapsedSub[key] = false;
          const wrap = document.getElementById(key);
          const applySubState = (collapsed) => {
            collapsedSub[key] = collapsed;
            if (wrap) wrap.classList.toggle('collapsed', collapsed);
            btn.classList.toggle('collapsed', collapsed);
            btn.setAttribute('aria-expanded', String(!collapsed));
          };
          applySubState(collapsedSub[key]);
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            applySubState(!collapsedSub[key]);
          });
        });
        document.querySelectorAll('.lock-btn').forEach(btn => {
          const g = btn.dataset.group;
          const sKey = btn.dataset.sub;
          const initialState = g ? locked[g] : lockedSub[sKey];
          setLockButtonState(btn, initialState);
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const g = btn.dataset.group;
            const sKey = btn.dataset.sub;
            if (g) {
              applyGroupLockState(g, !locked[g]);
            } else if (sKey) {
              applySubLockState(sKey, !lockedSub[sKey]);
            }
          });
        });
        els.savedPanelToggle?.addEventListener('click', (e) => {
          e.preventDefault();
          openSaveModal();
        });
        els.modeToggle.addEventListener('click', () => {
          uiMode = uiMode === 'dropdown' ? 'expanded' : 'dropdown';
          updateModeToggleLabel();
          init();
          composeAndRender();
        });
      }
      els.randomAll.addEventListener('click', randomAllVisible);
      els.copyPrompt.addEventListener('click', async () => {
        const t = els.promptOutput.textContent;
        if (!t) return;
        try {
          await navigator.clipboard.writeText(t);
          showCopyFeedback();
        } catch(e) {}
      });
      els.presetModalSave?.addEventListener('click', e => { e.preventDefault(); handleSavePreset(); });
      els.presetModalCancel?.addEventListener('click', e => { e.preventDefault(); closeSaveModal(); });
      els.presetModalOverlay?.addEventListener('click', e => {
        if (e.target === els.presetModalOverlay) closeSaveModal();
      });
      els.presetModalInput?.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          handleSavePreset();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          closeSaveModal();
        }
      });
      els.customSaveBtn?.addEventListener('click', e => { e.preventDefault(); handleCustomSave(); });
      els.customCancelBtn?.addEventListener('click', e => { e.preventDefault(); closeCustomModal(); });
      els.customAddTrigger?.addEventListener('click', e => { e.preventDefault(); resetCustomForm(); openCustomModal(); });
      els.customModalClose?.addEventListener('click', e => { e.preventDefault(); closeCustomModal(); });
      els.customModalOverlay?.addEventListener('click', e => {
        if (e.target === els.customModalOverlay) closeCustomModal();
      });
      

      init();
      bindClicks();
</script>
  </body>
</html>
